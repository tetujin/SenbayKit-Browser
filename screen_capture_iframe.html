<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="css/jquery-ui.css">
  <script src="js/jquery/jquery-1.12.4.js"></script>
  <script src="js/jquery/jquery-ui.js"></script>

  <script src="js/QR/jsQR.js"></script>

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">

  <title>SenbayKit-Browser | [DEMO] Screen Capture</title>

  <link href="css/card-ui.css" rel="stylesheet">
  <!-- <script src="https://cdn.WebRTC-Experiment.com/getScreenId.js"></script> -->
  <script type="text/javascript" src="js/senbay/BaseX.js" charset="utf-8"></script>
  <script type="text/javascript" src="js/senbay/SenbayFormat.js" charset="utf-8"></script>
  <script type="text/javascript" src="js/senbay/SenbayReader.js" charset="utf-8"></script>
  <script type="text/javascript" src="js/chart/Chart.min.js" charset="utf-8"></script>
  <script type="text/javascript" src="js/senbay/SenbayWidget.js" charset="utf-8"></script>
  <script type="text/javascript" src="js/senbay/SenbayViewer.js" charset="utf-8"></script>
  <script type="text/javascript" src="js/senbay/SenbayScreenCapture.js" charset="utf-8"></script>

  <style type="text/css">
    #stream-widget {
      position:fixed;
      width: 100%;
      height: 500px;
      left: 0;
      bottom: -550px;
    }
    #youtube-frame {
      /** z-index:0; **/
      position:fixed;
      width: 100%;
      left: 0;
      top: 0;
      padding:10px 10px 10px 10px;
    }
    #set{
      position:relative;
      width: 100%;
      top: 500px;
    }
    #controller-views{
      z-index:100;
      position:fixed;
      width: 100%;
      left: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.2);
      text-align: center;
      vertical-align: middle;
    }
    #clock-base {
      width: 100px;
      height: 100px;
      position: relative;
    }
    .clock {
      width: 100px;
      height: 100px;
      position: absolute;
      top: 0px;
      left: 0px;
    }
    .clock-widget {
      width: 120px;
      height: 120px;
    }
    .arrow-widget {
      width: 100px;
      height: 100px;
    }
  </style>

  <script>

    var screenCapture = null;
    var reader = null;
    var isFirstFrame = false
    $(function() {

      // init reader
      initAll();

      // setup an enbedded YouTube Link
      var youtubeId = getParam('v')
      var url = 'https://www.youtube.com/embed/'+youtubeId
      var youtubeFrame = document.getElementById('youtube-frame')
      youtubeFrame.src = url

      document.getElementById('generate-chart-btn').onclick = function(){
        var x = document.getElementById("value-1").value;
        var y = document.getElementById("value-2").value;
        var z = document.getElementById("value-3").value;
        var buffer = Number(document.getElementById("bufferValue").value);
        console.log([x,y,z],buffer,"set")
        generateChart([x,y,z],buffer,"set")
      }
    });

    function selectScreen(){
      var video = document.getElementById('mv');
      screenCapture = new SenbayScreenCapture(video);
      screenCapture.start(function(success){
        if (success) {
          console.log("Start Screen Capturing")
          isFirstFrame = true;
          startQRcodeDecode()
        }else{
          console.error("Error: Screen Capturing")
        }
      });
    }

    function startQRcodeDecode(){

      if (reader != null){
        reader.stop()
        reader = null
      }
      let baseNumber = Number(document.getElementById("baseNumber").value)

      reader = new SenbayReader('mv',baseNumber);
      var interval = 100
      // start reader with an observer
      reader.start(interval, function(json){
        console.log("decode::",json)

        updateWidgets(json);

        document.getElementById("set").hidden = false

        // analog clock
        var timeWidget = document.getElementById('time')
        var time = new Date(json.TIME * 1000)
        hour.style.transform = "rotate("+(time.getHours()*30+time.getMinutes()*0.5)+"deg)";
        minute.style.transform = "rotate("+(time.getMinutes()*6)+"deg)";
        second.style.transform = "rotate("+(time.getSeconds()*6)+"deg)";

        // arrow
        var arrow = document.getElementById('arrow')
        arrow.style.transform = "rotate(" + json.HEAD + "deg)";

        if (isFirstFrame) {
          isFirstFrame = false;
          var buffer = Number(document.getElementById("bufferValue").value);
          // if (json.ACCX) generateChart(['ACCX','ACCY','ACCZ'],buffer,"set")
          // if (json.PITC) generateChart(['PITC','YAW','ROLL'],buffer,"set")
          // if (json.SPEE) generateChart(['SPEE'],buffer,"set")
          // if (json.AIRP) generateChart(['AIRP'],buffer,"set")
          // if (json.ALTI) generateChart(['ALTI'],buffer,"set")
        }
      });

      reader.detectHandler = function(raw){
        // console.log("detect::",raw)
      }

      reader.errorHandler = function(e){
        console.log("error::",e)
      }
    }

    function stopQRcodeDecode(){
      reader.stop();
      screenCapture.stop()
      document.getElementById("set").hidden = true
    }

    function getParam(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
  </script>

</head>
<body>
  <div id="controller-views">
    <button type="button" name="button" onclick="selectScreen()">start</button>
    <button type="button" name="button" onclick="stopQRcodeDecode()">stop</button>
    <input type="text" name="" id="baseNumber" value="121" placeholder="Please input 121 or 122. The default value is 122.">
  </div>

  <iframe id="youtube-frame" width="100%" height="500" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe>

  <div class="container" id="set" hidden>
    <!-- Map Widget -->
    <div id="map-widget" class="ui-widget-content ui-widget-map draggable resizable">
      <div id="map"></div>
    </div>
    <div class="ui-widget-content ui-widget-raw draggable resizable clock-widget">
      <p id="time"></p>
      <div id="clock-base">
        <img src="img/dial.png" class="clock"><!--文字盤-->
        <img src="img/hour.png"   id="hour" class="clock"><!--短針-->
        <img src="img/minute.png" id="minute" class="clock"><!--長針-->
        <img src="img/second.png" id="second" class="clock"><!--秒針-->
      </div>
    </div>

    <div class="ui-widget-content ui-widget-raw draggable resizable arrow-widget">
      <img id="arrow" src="img/arrow.png" alt="">
    </div>
    <!-- Controller Widget -->
    <div class="ui-widget-content ui-widget-controller draggable resizable">
      <h3>Generate a New Chart</h3>
      <input type="button" name="" value="Refresh Valid Keys" onclick="refreshValidKeys()"><br>
      Value-1: <select class="" name="" id="value-1"></select><br>
      Value-2: <select class="" name="" id="value-2"></select><br>
      Value-3: <select class="" name="" id="value-3"></select><br>
      Buffer: <input type="text" name="" value="100" id="bufferValue"><br>
      <button type="button" name="button" id="generate-chart-btn">chart</button>
    </div>

    <!-- Raw Data Widget -->
    <div class="ui-widget-content ui-widget-raw draggable resizable" >
      <p id="raw"></p>
    </div>


  </div><!-- End demo -->


  <!-- Video Widget -->
  <div id='stream-widget' class="ui-widget-content ui-widget-video draggable resizable">
    <video id="mv" controls autoplay width="100%"></video>
  </div>

  <!-- JavaScript -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmdE_8jjp-eD8p6TI1gpmEU-ycT8VERCQ&callback=initMap"
    async defer></script>


</body>
</html>
